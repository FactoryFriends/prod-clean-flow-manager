<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>prod-clean-flow-manager</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />

    <meta property="og:title" content="prod-clean-flow-manager" />
    <meta property="og:description" content="Lovable Generated Project" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
    <!-- QZ Tray Direct Connection -->
    <script>
      // Create QZ object directly without external libraries
      window.qz = {
        websocket: {
          connect: function() {
            return new Promise((resolve, reject) => {
              try {
                console.log('Attempting to connect to QZ Tray websocket...');
                const ws = new WebSocket('ws://localhost:8181');
                
                const timeout = setTimeout(() => {
                  ws.close();
                  reject(new Error('Connection timeout - QZ Tray might not be running'));
                }, 5000);
                
                ws.onopen = () => {
                  clearTimeout(timeout);
                  console.log('QZ Tray websocket connected successfully');
                  window.qz._ws = ws;
                  resolve();
                };
                
                ws.onerror = (error) => {
                  clearTimeout(timeout);
                  console.error('QZ Tray websocket error:', error);
                  reject(new Error('Failed to connect to QZ Tray. Make sure QZ Tray is running and accepting connections.'));
                };
                
                ws.onclose = (event) => {
                  clearTimeout(timeout);
                  console.log('QZ Tray websocket closed. Code:', event.code, 'Reason:', event.reason);
                  if (event.code !== 1000) {
                    reject(new Error(`Connection closed unexpectedly. Code: ${event.code}`));
                  }
                };
              } catch (error) {
                console.error('Error creating websocket:', error);
                reject(error);
              }
            });
          },
          disconnect: function() {
            if (window.qz._ws) {
              window.qz._ws.close();
              window.qz._ws = null;
            }
          },
          isActive: function() {
            return window.qz._ws && window.qz._ws.readyState === WebSocket.OPEN;
          }
        },
        printers: {
          find: function() {
            return new Promise((resolve, reject) => {
              if (!window.qz.websocket.isActive()) {
                reject(new Error('QZ Tray not connected'));
                return;
              }
              
              const id = Math.random().toString(36).substr(2, 9);
              const message = {
                call: 'printers.find',
                params: [],
                uid: id
              };
              
              const handleMessage = (event) => {
                const response = JSON.parse(event.data);
                if (response.uid === id) {
                  window.qz._ws.removeEventListener('message', handleMessage);
                  if (response.error) {
                    reject(new Error(response.error));
                  } else {
                    resolve(response.result);
                  }
                }
              };
              
              window.qz._ws.addEventListener('message', handleMessage);
              window.qz._ws.send(JSON.stringify(message));
            });
          }
        },
        print: function(config, data) {
          return new Promise((resolve, reject) => {
            if (!window.qz.websocket.isActive()) {
              reject(new Error('QZ Tray not connected'));
              return;
            }
            
            const id = Math.random().toString(36).substr(2, 9);
            const message = {
              call: 'print',
              params: [config, data],
              uid: id
            };
            
            const handleMessage = (event) => {
              const response = JSON.parse(event.data);
              if (response.uid === id) {
                window.qz._ws.removeEventListener('message', handleMessage);
                if (response.error) {
                  reject(new Error(response.error));
                } else {
                  resolve(response.result);
                }
              }
            };
            
            window.qz._ws.addEventListener('message', handleMessage);
            window.qz._ws.send(JSON.stringify(message));
          });
        }
      };
      
      console.log('QZ Tray direct connection object created');
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
